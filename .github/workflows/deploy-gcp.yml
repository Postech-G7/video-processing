name: 'Deploy GCP'

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 'Check out repository'
        uses: 'actions/checkout@v4'

      - name: 'Set up Node.js'
        uses: 'actions/setup-node@v4'
        with:
          node-version: '20.x'

      - name: 'Install dependencies'
        run: 'npm install'

      - name: 'Create env file'
        run: |
          touch .env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "GCLOUD_PROJECT_ID=${{ secrets.GCLOUD_PROJECT_ID }}" >> .env
          echo "GCLOUD_STORAGE_BUCKET=${{ secrets.GCLOUD_STORAGE_BUCKET }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}" >> .env
          echo "NODE_ENV=production" >> .env

      - name: 'Run Prisma Migrations'
        run: |
          npx prisma generate
          npx prisma migrate deploy

      - name: 'Authenticate to GCP'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.CI_CD_GCP_POSTECH_GRUPO7 }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
        with:
          project_id: '${{ secrets.GCLOUD_PROJECT_ID }}'

      - name: 'Configure Docker for GCP'
        run: 'gcloud auth configure-docker gcr.io'

      - name: 'Build and push Docker image'
        run: |
          docker build -t gcr.io/${{ secrets.GCLOUD_PROJECT_ID }}/video-processing .
          docker push gcr.io/${{ secrets.GCLOUD_PROJECT_ID }}/video-processing

      - name: 'Deploy to Cloud Run'
        run: |
          gcloud run deploy video-processing \
            --image gcr.io/${{ secrets.GCLOUD_PROJECT_ID }}/video-processing \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 1 \
            --set-secrets DATABASE_URL=projects/470771286195/secrets/DATABASE_URL:latest \
            --set-secrets GOOGLE_APPLICATION_CREDENTIALS=projects/470771286195/secrets/GOOGLE_APPLICATION_CREDENTIALS:latest \
            --set-secrets GCLOUD_PROJECT_ID=projects/470771286195/secrets/GCLOUD_PROJECT_ID:latest \
            --set-secrets GCLOUD_STORAGE_BUCKET=projects/470771286195/secrets/GCLOUD_STORAGE_BUCKET:latest \
            --set-secrets JWT_SECRET=projects/470771286195/secrets/JWT_SECRET:latest \
            --set-secrets JWT_EXPIRES_IN=projects/470771286195/secrets/JWT_EXPIRES_IN:latest \
            --set-env-vars NODE_ENV=production \
            --set-env-vars NODE_TLS_REJECT_UNAUTHORIZED=0 

      - name: 'Set IAM policy binding for public access'
        run: |
          gcloud run services add-iam-policy-binding video-processing \
            --region=us-central1 \
            --member=allUsers \
            --role=roles/run.invoker
